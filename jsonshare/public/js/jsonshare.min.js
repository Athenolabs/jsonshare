

console.log('Hola');

function compartir_item(frm, doctype, codigo) {
    frm.add_custom_button(__('Share'), function () {
        frappe.call({
            method: "jsonshare.utils.obtener_usuarios",
            callback: function callback(response) {
                var dialog = new frappe.ui.Dialog({
                    title: __('Compartir Item'),
                    fields: [{
                        fieldtype: 'Select',
                        fieldname: 'user_share',
                        label: __('Seleccione Usuario'),
                        reqd: true,
                        options: response.message,
                        description: __('Seleccione el host/usuario con quien quiera compartir el Item')
                    }, {
                        fieldtype: 'Button',
                        fieldname: 'btn_share',
                        label: __('Compartir'),
                        options: '',
                        description: __('')
                    }]
                });

                dialog.show();

                dialog.fields_dict.btn_share.$wrapper.on('click', function (e) {
                    console.log(dialog.fields_dict.user_share.value);

                    frappe.call({
                        method: "jsonshare.api.crud",
                        args: {
                            item: codigo,
                            usuario: dialog.fields_dict.user_share.value,
                            doctype: doctype
                        },
                        callback: function callback() {}
                    });
                });
            }
        });
    }).addClass("btn-success");
}

frappe.ui.form.on("Item", {
    refresh: function refresh(frm) {
        var item_code = frm.doc.item_code;
        compartir_item(frm, 'Item', item_code);
    }
});

frappe.ui.form.on("Customer", {
    refresh: function refresh(frm) {
        var customer_name = frm.doc.customer_name;
        compartir_item(frm, 'Customer', customer_name);
    }
});

frappe.ui.form.on("Supplier", {
    refresh: function refresh(frm) {
        var supplier_name = frm.doc.supplier_name;
        compartir_item(frm, 'Supplier', supplier_name);
    }
});